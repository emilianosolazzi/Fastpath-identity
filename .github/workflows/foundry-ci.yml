name: Foundry CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: stable

      - name: Install dependencies
        run: |
          forge install --no-git foundry-rs/forge-std
          forge install --no-git OpenZeppelin/openzeppelin-contracts

      - name: Show tool versions
        run: |
          forge --version
          solc --version || true

      - name: Build
        run: forge build

      - name: Test
        run: forge test --gas-report

      - name: Gas benchmark scenarios
        run: forge test --match-path tests/ERC721H_Gas.t.sol --gas-report

      - name: Invariant tests (FFI enabled)
        run: forge test --match-path tests/ERC721H_Invariant.t.sol --ffi

      - name: Compatibility tests
        run: forge test --match-path tests/ERC721H_Compatibility.t.sol

      - name: Rollup fork smoke tests
        run: forge test --match-path tests/ERC721H_RollupForks.t.sol

  static-analysis:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: stable

      - name: Install dependencies
        run: |
          forge install --no-git foundry-rs/forge-std
          forge install --no-git OpenZeppelin/openzeppelin-contracts

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install solhint
        run: npm ci

      - name: Run solhint
        run: npm run solhint

      - name: Install Slither
        run: |
          python -m pip install --upgrade pip
          pip install slither-analyzer

      - name: Run Slither
        run: slither . --config-file slither.config.json || true

      - name: Run Mythril (Docker)
        run: docker run --rm -v "$PWD":/src mythril/myth analyze /src/src/ERC-721H.sol --solv 0.8.30 --execution-timeout 120 || true
